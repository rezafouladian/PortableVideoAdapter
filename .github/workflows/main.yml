name: Build (RP2350)

on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      PICO_SDK_PATH: ${{ github.workspace }}/pico-sdk

    steps:
      - name: Checkout repository (and submodules if any)
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Debug paths
        run: |
          echo "GITHUB_WORKSPACE=${GITHUB_WORKSPACE}"
          pwd
          ls -la

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            cmake ninja-build \
            gcc-arm-none-eabi binutils-arm-none-eabi \
            python3 git

      - name: Cache pico-sdk
        uses: actions/cache@v4
        with:
          path: ${{ github.workspace }}/pico-sdk
          key: pico-sdk-${{ runner.os }}-2.2.0

      - name: Fetch pico-sdk (if not cached)
        run: |
          if [ ! -d "${PICO_SDK_PATH}/.git" ]; then
            rm -rf "${PICO_SDK_PATH}"
            git clone --depth 1 --branch 2.2.0 https://github.com/raspberrypi/pico-sdk.git "${PICO_SDK_PATH}"
          fi
          git -C "${PICO_SDK_PATH}" submodule update --init --recursive

      - name: Configure
        run: |
          cmake -S . -B build -G Ninja -DCMAKE_BUILD_TYPE=Release

      - name: Build
        run: |
          cmake --build build

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: PortableVideoAdapter-build
          path: |
            build/*.uf2
            build/*.elf
